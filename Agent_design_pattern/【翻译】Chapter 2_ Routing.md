---
AIGC:
  Label: "1"
  ContentProducer: "001191330110MADHPQQY7L10000"
  ProduceID: "ExportRequest(files=[ExportFile(docType=2, fileType=3)])"
  ReservedCode1: "3187855ddc34ef804f979779c108199d57c3dcfa49d5a33e15e249ee509b1757"
  ContentPropagator: "001191330110MADHPQQY7L10000"
  PropagateID: "ExportRequest(files=[ExportFile(docType=2, fileType=3)])"
  ReservedCode2: ""
---
### 第2章：路由 
### 路由模式概览 
尽管通过提示链进行顺序处理是利用语言模型执行确定性、线性工作流的基础技术，但在需要自适应响应的场景中，其适用性却受到限制。现实世界中的智能代理系统往往必须根据环境状态、用户输入或前序操作的结果等动态因素，从多个潜在行动中做出权衡与选择。正是这种动态决策能力——它决定了控制流如何流向不同的专业功能、工具或子流程——由一种称为“路由”的机制来实现。 
路由将条件逻辑引入到代理的运行框架中，使其从固定的执行路径转变为一种模式：代理会动态评估特定条件，从而在一系列可能的后续行动中做出选择。这使得系统行为更加灵活，并能更好地适应具体情境。 
例如，一个专为客户咨询设计的客服代理，若配备路由功能，便可首先对 incoming query 进行分类，以明确用户意图。根据这一分类结果，代理可将查询直接转交给专门的客服人员进行即时答疑，或调用数据库检索工具获取账户信息，亦或将复杂问题升级至更高层级处理，而无需默认采用单一、预先设定的响应路径。因此，采用路由技术的更高级代理能够： 
1. 分析用户的查询。 
2. 根据查询意图进行路由： 
○ 如果意图是“查询订单状态”，则转接到与订单数据库交互的子代理或工具链。 
○ 如果意图是“产品信息”，则转接至负责搜索产品目录的子代理或连锁机构。 
○ 如果意图是“技术支持”，则转接到另一条链路，该链路可访问故障排除指南或直接升级至人工客服。 
○如果意图不明确，转至澄清子代理或提示链。 
路由模式的核心组件是一种执行评估并引导流程的机制。这种机制可以通过多种方式实现： 
· 基于大模型的路由：可以直接提示语言模型分析输入内容，并输出一个特定的标识符或指令，以指示下一步操作或目标地点。例如，提示词可以要求大模型“分析以下用户查询，仅输出类别：‘订单状态’、‘产品信息’、‘技术’”。 
支持’，或‘其他’。随后，智能系统会读取这一输出，并据此引导工作流程。 
基于嵌入的路由：输入查询可被转换为向量嵌入（参见RAG，第14章）。随后，将该嵌入与代表不同路由或功能的嵌入进行对比，选择与查询嵌入最相似的路由进行处理。这种方法特别适用于语义路由，因为决策依据的是输入的语义含义，而不仅仅是关键词。 
基于规则的路由：这种方法涉及使用预定义的规则或逻辑（例如，if-else语句、switch-case语句），这些规则或逻辑依据从输入中提取的关键字、模式或结构化数据。与基于大模型的路由相比，这种方法通常更快且更具确定性，但对处理细微或新颖的输入时灵活性较低。 
基于机器学习模型的路由方法：它采用一种判别模型，例如分类器，并经过专门训练，利用少量标注数据完成路由任务。尽管这种方法与基于嵌入的方法在概念上存在相似之处，但其核心特征在于监督微调过程——通过调整模型参数，使其生成针对特定任务的专用路由功能。这种技术与基于大语言模型的路由方法截然不同，因为其决策组件并非在推理阶段执行提示的生成式模型，而是将路由逻辑直接编码于微调后模型所学习到的权重之中。当然，大语言模型可能被用于预处理步骤，以生成合成数据来扩充训练集，但它们本身并不参与实时的路由决策过程。 
路由机制可以在代理运行周期的多个关键节点中实施。它们既可应用于初始阶段以对主要任务进行分类，也可在处理链的中间环节用于决定后续行动，还可于子程序执行期间从一组工具中挑选出最合适的那一个。 
像LangChain、LangGraph以及谷歌的Agent开发者套件（ADK）这样的计算框架，都提供了明确的构建模块，用于定义和管理此类条件逻辑。其中，LangGraph凭借其基于状态的图架构，特别适用于复杂的路由场景——在这种场景中，决策会根据整个系统的累积状态而动态变化。同样，谷歌的ADK则提供了构建智能体能力与交互模型的基础组件，这些组件正是实现路由逻辑的核心基础。在这些框架提供的执行环境中，开发者可以定义各种可能的运行路径，以及决定计算图中节点间转换的函数或基于模型的评估机制。 
路由的实现使系统能够超越确定性的顺序处理，从而促进更具适应性的执行流程开发。 
### 能够动态且恰当地响应更广泛的输入和状态变化。 
### 实际应用与用例 
路由模式是自适应代理系统设计中的关键控制机制，使它们能够根据变化的输入和内部状态动态调整执行路径。其应用广泛，为多个领域提供了不可或缺的条件逻辑层。 
在人机交互中，例如与虚拟助手或人工智能驱动的导师互动时，路由技术被用于解析用户意图。通过对自然语言查询的初步分析，系统可确定最合适的后续操作——无论是调用特定的信息检索工具、转接至人工客服，还是根据用户表现选择课程中的下一模块。这使得系统能够突破线性对话流程，实现情境化的响应。 
在自动化数据与文档处理流程中，路由扮演着分类和分发的功能。系统会根据内容、元数据或格式，对传入的数据（如电子邮件、支持工单或API负载）进行分析，随后将每项任务引导至相应的工作流，例如销售线索导入流程、针对JSON或CSV格式的特定数据转换功能，或是紧急问题的升级处理路径。 
在涉及多个专业工具或智能体的复杂系统中，路由扮演着高层次调度员的角色。一个由独立智能体组成的科研系统，分别负责信息搜索、摘要提炼和分析，便会通过路由器根据当前目标，将任务分配给最合适的智能体。同样地，AI 编码助手也利用路由功能，先识别编程语言及用户意图——是调试、解释，还是翻译——再将代码片段传递给相应的专业工具。 
### 最终，路由提供了实现逻辑仲裁的能力，这是构建功能多样且具备情境感知能力系统的关键。它将一个智能体从预先定义序列的静态执行者，转变为能够在不断变化的环境中，针对完成任务的最有效方法做出决策的动态系统。 
### 动手代码示例（LangChain） 
在代码中实现路由，涉及定义可能的路径以及决定选择哪条路径的逻辑。像LangChain和LangGraph这样的框架提供了 
针对此的具体组件和结构。LangGraph 基于状态的图结构尤其便于直观地可视化和实现路由逻辑。 
这段代码展示了如何使用LangChain和谷歌的生成式AI构建一个简单的代理式系统。它设置了一个“协调器”，根据用户请求的意图（预订、信息查询或不明确），将请求路由至不同的模拟“子代理”处理程序。系统利用语言模型对请求进行分类，随后将其交由相应的处理函数，从而模拟了多智能体架构中常见的基本委托模式。 
首先，确保你已安装所需的库： 
你还需要为你选择的语言模型（例如，OpenAI、Google Gemini、Anthropic）设置包含API密钥的环境。 
如前所述，这段Python代码使用LangChain库和谷歌的生成式AI模型——特别是Gemini 2.5 Flash，构建了一个简单的代理式系统。 
详细说明，它定义了三个模拟的子代理处理器：预订处理器、信息处理器和不明确处理器，每个处理器均旨在处理特定类型的请求。 
核心组件是 coordinator_router_chain，它利用 ChatPromptTemplate 指示语言模型将传入的用户请求归类为以下三个类别之一：“预订者”、“信息”或“不明确”。该路由器链的输出随后由 RunnableBranch 使用，以将原始请求分派到相应的处理函数。RunnableBranch 会检查语言模型的决策，并根据判断结果，将请求数据传递给预订处理程序、信息处理程序，或不明确处理程序。最后，coordinator_agent 将这些组件整合在一起：首先对请求进行路由以做出决策，然后再将请求交由选定的处理程序执行。最终的输出则从处理程序的响应中提取出来。 
主函数通过三个示例请求展示了系统的使用方式，演示了不同输入如何被模拟的智能体路由并处理。同时，代码中还包含了对语言模型初始化的错误处理机制，以确保系统运行的稳定性。整体代码结构仿照了一个基本的多智能体框架：由一个中央协调器根据任务意图，将具体工作分配给各专业化的智能体执行。 
动手代码示例（Google ADK） 
代理开发工具包（ADK）是一个用于构建智能系统的核心框架，为定义代理的能力与行为提供了结构化环境。与基于显式计算图的架构不同，在ADK范式中，路由通常通过定义一组离散的“工具”来实现——这些工具代表了代理的功能。当接收到用户查询时，框架会根据其内部逻辑，借助底层模型将用户意图精准匹配到相应的功能处理程序，从而选择合适的工具予以响应。 
这段Python代码演示了一个使用Google ADK库的Agent开发工具包（ADK）应用示例。它设置了一个“协调器”代理，根据预定义的指令，将用户请求路由至专门的子代理——负责预订的“Booker”和提供一般信息的“Info”。随后，这些子代理会利用特定工具来模拟处理请求的过程，从而展示了代理系统中一种基本的委托模式。 
该脚本由一个主协调器代理和两个专业子代理组成：Booker 和 Info。每个专业代理都配备了一个 FunctionTool，用于封装模拟实际操作的 Python 函数。其中，booking_handler 函数模拟处理航班和酒店预订，而 info_handler 函数则模拟获取通用信息。此外，脚本中还包含 unclear_handler 作为备选方案，以应对协调器无法委派的请求——尽管在当前的协调逻辑中，main_run_coordinator 函数并未明确将其用于委派失败的情况。 
根据其说明，协调员代理的主要职责是分析用户传入的消息，并将其自动分配给预订员或信息员代理之一。这种分配由ADK的自动流转机制完成，因为协调员已定义了子代理。run_coordinator函数会设置一个InMemoryRunner，创建用户和会话ID，然后通过该Runner将用户的请求传递给协调员代理进行处理。Runner的run方法会逐个处理请求事件，并最终从event.content中提取出响应文本。 
### 主功能通过运行协调器并提交不同请求，展示了系统如何使用：它将预订请求分派给预订员，而将信息查询请求转交给信息代理。 
### 一目了然 
什么：代理型系统通常需要应对多种多样的输入和情境，而这些情况无法通过单一的线性流程来处理。简单的顺序工作流缺乏根据上下文做出决策的能力。若没有一种机制能够为特定任务选择合适的工具或子流程，系统将始终僵化且缺乏适应性。这种局限性使得构建能够有效应对现实世界用户请求复杂性和多样性的高级应用变得极为困难。 
为什么：路由模式通过在代理的操作框架中引入条件逻辑，提供了一种标准化的解决方案。它使系统能够首先分析传入的查询，以确定其意图或性质。根据这一分析，代理会动态地将控制流程导向最合适的专用工具、功能或子代理。这一决策可由多种方法驱动，包括提示大型语言模型、应用预定义规则，或利用基于嵌入的语义相似性。 
最终，路由将一条静态、预先设定的执行路径转化为灵活且具备情境感知的工作流，从而能够选择最合适的行动方案。 
经验法则：当代理需要根据用户输入或当前状态，在多个独立的工作流、工具或子代理之间做出选择时，应采用路由模式。这对于需要对传入请求进行分类或优先级排序，以处理不同类型任务的应用尤其重要，例如客服机器人能够区分销售咨询、技术支持和账户管理等问题。 
视觉摘要： 
关键要点 
●路由功能使客服人员能够根据特定条件，动态决定工作流中的下一步操作。 
●它使代理能够处理多样化输入并调整自身行为，从而超越线性执行模式。 
●路由逻辑可采用大模型、基于规则的系统或嵌入式相似性实现。 
### ●像LangGraph和Google ADK这样的框架提供了结构化的方法，用于在智能体工作流中定义和管理路由，尽管它们采用了不同的架构设计。 
### 结论 
路由模式是构建真正动态且响应敏捷的智能系统的关键步骤。通过实现路由功能，我们不仅超越了简单、线性的执行流程，更能赋予智能体自主判断的能力，使其能够灵活地处理信息、响应用户输入，并合理调用可用工具或子智能体。 
我们已经看到，路由技术可广泛应用于多个领域，从客户服务聊天机器人到复杂的数据处理流程。这种能够分析输入并根据条件引导工作流的能力，正是构建智能体的核心所在——这些智能体能从容应对现实任务中固有的多样性与不确定性。 
使用LangChain和Google ADK的代码示例展示了两种不同但同样有效的路由实现方法。LangGraph基于图结构的设计，提供了一种直观且明确的方式来定义状态与转换，特别适合处理具有复杂路由逻辑的多步骤工作流。而Google ADK则更侧重于定义独立的功能模块（工具），并依靠框架将用户请求智能地路由至相应的工具处理器——对于那些具备清晰、离散动作集的智能体来说，这种方法通常更为简单易用。 
掌握路由模式是构建能够智能应对不同场景、并根据上下文提供定制化响应或行动的智能体的关键。这是打造功能多样且稳健的代理型应用的核心要素。 
参考文献 
1. LangGraph 文档：https://www.langchain.com/ 
2. Google 代理开发者工具包文档：https://google.github.io/adk-docs/ 
